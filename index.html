<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë™í˜¸íšŒ ì¶œì„ ì²´í¬</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#f7f7f7; padding:20px; }
    .box { max-width:520px; margin:auto; background:#fff; padding:18px 18px 14px;
           border-radius:14px; box-shadow:0 10px 25px rgba(0,0,0,.08); }
    label { font-size:13px; color:#444; display:block; margin-top:10px; }
    input { width:100%; padding:12px; border:1px solid #ddd; border-radius:12px; font-size:16px; }
    button { width:100%; padding:14px; font-size:18px; border-radius:12px;
             border:0; background:#2563eb; color:#fff; cursor:pointer; margin-top:12px; }
    button:disabled { background:#999; cursor:not-allowed; }
    pre { background:#f1f5f9; padding:12px; border-radius:12px; margin-top:14px; white-space:pre-wrap; }
    .small { font-size:12px; color:#555; margin-top:10px; line-height:1.4; }
    .pill { display:inline-block; padding:4px 8px; background:#eef2ff; border-radius:999px; font-size:12px; color:#3730a3; }
    .row { display:flex; gap:10px; }
    .row > div { flex:1; }
    .copybtn { margin-top:8px; background:#111827; }
  </style>
</head>
<body>
  <div class="box">
    <h2>ğŸ“ ë™í˜¸íšŒ ì¶œì„ ì²´í¬</h2>

    <div class="small">
      <span class="pill" id="meta"></span>
    </div>

    <label>Knox ID (í•„ìˆ˜)</label>
    <input id="knox" placeholder="ì˜ˆ: seonhong.kim / abc123" autocomplete="off" />

    <label>ì´ë¦„ (ì„ íƒ)</label>
    <input id="name" placeholder="ì˜ˆ: ê¹€ì„ í™" autocomplete="off" />

    <div class="row">
      <div>
        <label>ê¸°ê¸° í† í° (ìë™ ìƒì„±, í° ê³ ìœ  ë„˜ë²„ ëŒ€ì²´)</label>
        <input id="deviceToken" readonly />
      </div>
      <div style="max-width:170px;">
        <label>&nbsp;</label>
        <button class="copybtn" onclick="copyToken()">í† í° ë³µì‚¬</button>
      </div>
    </div>

    <button id="btn" onclick="checkIn()">ì¶œì„ ì™„ë£Œ</button>

    <pre id="out">ì•ˆë‚´: Knox ID ì…ë ¥ í›„ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ 1íšŒì„±ìœ¼ë¡œ ìœ„ì¹˜Â·ì‹œê°„ì´ í™•ì¸ë©ë‹ˆë‹¤.</pre>

    <div class="small">
      ìš´ì˜ í¬ì¸íŠ¸:
      <br>â€¢ ë™ì¼ í–‰ì‚¬(eventId) ê¸°ì¤€, ê°™ì€ Knox IDëŠ” ì´ ê¸°ê¸°ì—ì„œ 1íšŒë§Œ ì²˜ë¦¬ë©ë‹ˆë‹¤(ì¤‘ë³µ ë°©ì§€).
      <br>â€¢ ê¸°ê¸° í† í°ì€ ë¸Œë¼ìš°ì €ê°€ ì œê³µí•˜ëŠ” â€œí° ê³ ìœ  IDâ€ê°€ ë¶ˆê°€í•˜ì—¬ ìƒì„±ë˜ëŠ” ëŒ€ì²´ ì‹ë³„ê°’ì…ë‹ˆë‹¤.
      <br>â€¢ ì¶œì„ ì™„ë£Œ í™”ë©´ì„ ìº¡ì²˜í•˜ì—¬ ì œì¶œí•˜ì„¸ìš”(ê°ì‚¬ ì¦ì ).
    </div>
  </div>

<script>
  // ---------- Helpers ----------
  function qs(name, def="") {
    const v = new URLSearchParams(location.search).get(name);
    return (v === null || v === undefined || v === "") ? def : v;
  }
  function toFixed(n, d=6) { return (typeof n === "number") ? n.toFixed(d) : String(n); }
  function uuid() {
    return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
      (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & (15 >> (c / 4))).toString(16)
    );
  }
  function setOut(msg) { document.getElementById("out").textContent = msg; }

  // ---------- Config ----------
  const EVENT_ID = qs("eventId", "event"); // í•„ìš”í•˜ë©´ URLì— ?eventId=20260206 ê°™ì´ ë¶™ì—¬ì„œ ì‚¬ìš©
  const ACC_MAX = parseFloat(qs("accMax", "150")); // ì •í™•ë„ í—ˆìš©ì¹˜(Â±m)
  document.getElementById("meta").textContent = `eventId=${EVENT_ID} | accMax=${ACC_MAX}m`;

  // ---------- Device token (phone unique number alternative) ----------
  const DEVICE_KEY = "club_device_token_v1";
  let deviceToken = localStorage.getItem(DEVICE_KEY);
  if (!deviceToken) {
    deviceToken = uuid();
    localStorage.setItem(DEVICE_KEY, deviceToken);
  }
  document.getElementById("deviceToken").value = deviceToken;

  function normalizeKnox(s) {
    return String(s || "").trim().toLowerCase();
  }
  function checkinKey(knoxId) {
    return `checkin_${EVENT_ID}_${knoxId}`; // same event + same knox => one check-in per device
  }

  // ---------- Copy token ----------
  async function copyToken() {
    try {
      await navigator.clipboard.writeText(deviceToken);
      setOut("âœ… ê¸°ê¸° í† í°ì´ ë³µì‚¬ëì–´.\n(ëŒ€ë¦¬ ì¶œì„ ë°©ì§€ìš©ìœ¼ë¡œ ìº¡ì²˜ì—ë„ í•¨ê»˜ ë‚¨ê²¨ì¤˜)");
    } catch (e) {
      setOut("ë³µì‚¬ ê¶Œí•œì´ ë§‰í˜€ìˆì–´.\ní† í°ì„ ê¸¸ê²Œ ëˆŒëŸ¬ ì§ì ‘ ë³µì‚¬í•´ì¤˜:\n" + deviceToken);
    }
  }

  // ---------- Main ----------
  function checkIn() {
    const btn = document.getElementById("btn");
    btn.disabled = true;
    btn.textContent = "ìœ„ì¹˜ í™•ì¸ ì¤‘...";

    const knox = normalizeKnox(document.getElementById("knox").value);
    const name = document.getElementById("name").value.trim();

    if (!knox) {
      setOut("Knox IDë¥¼ ì…ë ¥í•´ì¤˜.");
      btn.disabled = false; btn.textContent = "ì¶œì„ ì™„ë£Œ";
      return;
    }

    // Duplicate prevention (same device)
    const k = checkinKey(knox);
    if (localStorage.getItem(k) === "DONE") {
      setOut("ì´ë¯¸ ì´ ê¸°ê¸°ì—ì„œ í•´ë‹¹ í–‰ì‚¬ ì¶œì„ ì™„ë£Œ ì²˜ë¦¬ëœ Knox IDì•¼.\n(ì¤‘ë³µ ì¶œì„ ë°©ì§€)\n\nknox: " + knox + "\ndeviceToken: " + deviceToken);
      btn.textContent = "ì´ë¯¸ ì™„ë£Œ";
      return;
    }

    if (!navigator.geolocation) {
      setOut("ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•Šì•„.");
      btn.disabled = false; btn.textContent = "ì¶œì„ ì™„ë£Œ";
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const now = new Date();
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const acc = pos.coords.accuracy;

        if (Number.isFinite(ACC_MAX) && acc > ACC_MAX) {
          setOut(
            "GPS ì •í™•ë„ê°€ ë„ˆë¬´ ë‚®ì•„ì„œ ì¶œì„ì„ ì™„ë£Œí•  ìˆ˜ ì—†ì–´.\n" +
            `ì •í™•ë„(Â±m): ${Math.round(acc)} / í—ˆìš©: ${ACC_MAX}\n\n` +
            "íŒ: ì°½ê°€/ì•¼ì™¸ì—ì„œ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì¼œê³  ì¬ì‹œë„í•´ì¤˜."
          );
          btn.disabled = false; btn.textContent = "ì¶œì„ ì™„ë£Œ";
          return;
        }

        // Mark done (device-level)
        localStorage.setItem(k, "DONE");

        setOut(
          "âœ… ì¶œì„ ì™„ë£Œ\n\n" +
          `eventId: ${EVENT_ID}\n` +
          `knoxId: ${knox}\n` +
          (name ? `name: ${name}\n` : "") +
          `time: ${now.toLocaleString()}\n` +
          `lat: ${toFixed(lat)}\n` +
          `lng: ${toFixed(lng)}\n` +
          `accuracy(Â±m): ${Math.round(acc)}\n\n` +
          `deviceToken: ${deviceToken}\n` +
          `userAgent: ${navigator.userAgent}\n\n` +
          "ì´ í™”ë©´ì„ ìº¡ì²˜í•´ì„œ ì œì¶œí•˜ë©´ ë©ë‹ˆë‹¤."
        );

        btn.textContent = "âœ… ì™„ë£Œë¨";
      },
      (err) => {
        setOut(
          "ìœ„ì¹˜ íšë“ ì‹¤íŒ¨: " + err.message + "\n\n" +
          "í•´ê²° íŒ:\n" +
          "- ë¸Œë¼ìš°ì € ìœ„ì¹˜ ê¶Œí•œ í—ˆìš©\n" +
          "- íœ´ëŒ€í° ìœ„ì¹˜ ì„œë¹„ìŠ¤ ON\n" +
          "- ì¹´í†¡ ì¸ì•± ë¸Œë¼ìš°ì €ë©´ 'ë¸Œë¼ìš°ì €ì—ì„œ ì—´ê¸°'\n" +
          "- iPhoneì€ Safari, AndroidëŠ” Chrome ê¶Œì¥"
        );
        btn.disabled = false; btn.textContent = "ì¶œì„ ì™„ë£Œ";
      },
      { enableHighAccuracy: true, timeout: 12000, maximumAge: 0 }
    );
  }
</script>
</body>
</html>

async function sha256Hex(input) {
  const data = new TextEncoder().encode(input);
  const hash = await crypto.subtle.digest("SHA-256", data);
  return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, "0")).join("");
}

async function getDeviceFingerprint() {
  const parts = [
    navigator.userAgent || "",
    navigator.language || "",
    Intl.DateTimeFormat().resolvedOptions().timeZone || "",
    navigator.platform || "",
    String(screen.width) + "x" + String(screen.height),
    String(window.devicePixelRatio || ""),
  ].join("|");
  // í•´ì‹œë¡œ ë§Œë“¤ì–´ì„œ ê·¸ëŒ€ë¡œ ë…¸ì¶œ(ê°œì¸ì •ë³´ ìµœì†Œí™”)
  return await sha256Hex(parts);
}
